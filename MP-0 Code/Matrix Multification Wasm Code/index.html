<!DOCTYPE html>
<html>
<head>
  <title>WASM Matrix Multiplication</title>
</head>
<body>
  <h1>Matrix Multiplication using WebAssembly</h1>
  <h2>Open console to see output</h2>

  <script>
    // Load WebAssembly module generated by Emscripten
    var Module = {
      onRuntimeInitialized: function () {
        const size = 512; // Size of the square matrix

        // Allocate memory for matrices
        const bytesPerElement = 8; // float64
        const totalBytes = size * size * bytesPerElement;

        const aPtr = Module._malloc(totalBytes);
        const bPtr = Module._malloc(totalBytes);
        const cPtr = Module._malloc(totalBytes);

        const a = new Float64Array(Module.HEAPF64.buffer, aPtr, size * size);
        const b = new Float64Array(Module.HEAPF64.buffer, bPtr, size * size);

        // Fill matrices A and B with random numbers
        for (let i = 0; i < size * size; i++) {
          a[i] = Math.random();
          b[i] = Math.random();
        }

        // Call C++ function multiplyMatrix(a, b, c, size)
        const start = performance.now();
        Module.ccall(
          'multiplyMatrix', null, ['number', 'number', 'number', 'number'],
          [aPtr, bPtr, cPtr, size]
        );
        const end = performance.now();
        console.log("WASM Matrix Multiplication Time:", (end - start).toFixed(2), "ms");

        // Free allocated memory
        Module._free(aPtr);
        Module._free(bPtr);
        Module._free(cPtr);
      }
    };

    // Page load time measurement
    window.addEventListener("load", () => {
      setTimeout(() => {
        const navEntry = performance.getEntriesByType("navigation")[0];
        if (navEntry && navEntry.loadEventEnd > 0) {
          console.log("Page Load Time:", navEntry.loadEventEnd.toFixed(2), "ms");
        } else if (performance.timing.loadEventEnd > 0) {
          const timing = performance.timing;
          const loadTime = timing.loadEventEnd - timing.navigationStart;
          console.log("Page Load Time:", loadTime + " ms");
        } else {
          console.warn("Could not measure page load time.");
        }
      }, 100); // Delay to ensure load event is fully registered
    });
  </script>

  <!-- Load the generated matrix_mul.js -->
  <script src="matrix_mul.js"></script>
</body>
</html>
